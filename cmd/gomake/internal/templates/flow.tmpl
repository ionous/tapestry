{{- with $type := . }}
// {{Pascal .Name}}
{{- /* 
    code doc 
*/ -}}
{{- if .UserComment }}
{{- range $i, $el := Lines .UserComment -}} 
{{- if $i }}//{{end}}{{""}} {{$el}}{{end}}{{end}}
{{- /*
    struct decl
*/}}
type {{Pascal .Name}} struct {
{{range Terms .}}{{/* loop over terms */ -}}
{{""}}	{{Pascal .GoId}} {{.GoDecl -}}
{{""}}	`if:"{{- if .Private}}internal{{else}}label={{if .IsInline}}_{{else}}{{.Key}}{{end}}{{end}}
{{- if .Optional}},optional{{end}}
{{- if .IsUnboxed}},type={{.GoType}}{{end}}"`
{{end}}{{/*ends range $terms*/ -}}
{{""}}	UserComment string
}
{{- /*
    slots
*/ -}}
{{if .Slots }}
// User implemented slots:
{{- range $slot := .Slots }}
var _ {{ScopeOf $slot}}{{Pascal $slot}} = (*{{Pascal $type.Name}})(nil)
{{end}}{{/*ends range slots*/}}
{{end }}{{/*ends if slots*/}}
{{template "compose.tmpl" .}}
{{- /*
    keys for each of the public members
*/ -}}
{{range Terms .}}{{/* loop over terms */ -}}
const {{Pascal .GoType}}_Field_{{Pascal .GoId}} = "{{Tokenize .GoId}}";
{{end}}{{/*ends range $terms*/ -}}
{{- /*
    marshal interface
*/ -}}
{{template "marshalSignature.tmpl" .}}
{{- /*
    repeating
*/ -}}
{{if ne .Name "position"}}{{/* fix: position should be removed */}}
{{template "repeating.tmpl" (RepeatData .Name false)}}
{{end}}{{/* end not position */}}
{{- /*
    flow contents
*/ -}}
type {{Pascal .Name}}_Flow struct { ptr* {{Pascal .Name}} }

func (n {{Pascal .Name}}_Flow) GetType() string { return {{Pascal .Name}}_Type }
func (n {{Pascal .Name}}_Flow) GetLede() string { return {{
    if .Spec.Value.Name}}"{{.Spec.Value.Name}}"{{else}}{{Pascal .Name}}_Type{{end}} }
func (n {{Pascal .Name}}_Flow) GetFlow() interface{} { return n.ptr }
func (n {{Pascal .Name}}_Flow) SetFlow(i interface{}) (okay bool) {
  if ptr, ok := i.(*{{Pascal .Name}}); ok {
    *n.ptr, okay = *ptr, true
  }
  return
}

func {{Pascal .Name}}_Optional_Marshal(m jsn.Marshaler, pv **{{Pascal .Name}}) (err error) {
  if enc := m.IsEncoding(); enc && *pv != nil {
    err = {{Pascal .Name}}_Marshal(m, *pv)
  } else if !enc {
    var v {{Pascal .Name}}
    if err = {{Pascal .Name}}_Marshal(m, &v); err == nil {
      *pv = &v
    }
  }
  return
}

func {{Pascal .Name}}_Marshal(m jsn.Marshaler, val *{{Pascal .Name}}) (err error) {
  m.SetComment(&val.UserComment)
  if err = m.MarshalBlock({{Pascal .Name}}_Flow{val}); err == nil {
{{- range $i, $term:= Terms .}}{{/* loop over terms */}}{{if not .Private}}
    e{{$i}} := m.MarshalKey("{{.Name}}", {{Pascal $type.Name}}_Field_{{Pascal .GoId}})
    if e{{$i}} == nil {
      e{{$i}} = {{ScopeOf .GoType}}{{Pascal .GoType -}}
      {{if .IsUnboxed}}_Unboxed{{end -}}
      {{if .Optional}}_Optional{{end -}}
      {{if .Repeats}}_Repeats{{end -}}
      _Marshal(m, &val.{{Pascal .GoId}})
    }
    if e{{$i}} != nil && e{{$i}} != jsn.Missing {
      m.Error(errutil.New(e{{$i}}, "in flow at", {{Pascal $type.Name}}_Field_{{Pascal .GoId}}))
    }
{{- end}}{{end}}
    m.EndBlock()
  }
  return
}
{{/* end of with */ -}}
{{end}}