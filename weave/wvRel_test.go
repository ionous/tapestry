package weave_test

import (
	"testing"

	"git.sr.ht/~ionous/tapestry/rt/kindsOf"
	"git.sr.ht/~ionous/tapestry/test/eph"
	"git.sr.ht/~ionous/tapestry/test/testweave"
	"git.sr.ht/~ionous/tapestry/weave/mdl"
	"github.com/kr/pretty"
)

// ensure we can create relations
// doesn't test contradictions, etc. since those are already tested by kinds
// ( and relation is just a special autogenerated kind )
func TestRelAssembly(t *testing.T) {
	var warnings mdl.Warnings
	unwarn := warnings.Catch(t.Fatal)
	defer unwarn()

	dt := testweave.NewWeaver(t.Name())
	defer dt.Close()
	dt.MakeDomain(dd("a"),
		&eph.Kinds{Kind: kindsOf.Relation.String()}, // declare the relation table
		&eph.Kinds{Kind: "p"},
	)
	dt.MakeDomain(dd("b", "a"),
		&eph.Kinds{Kind: "q"},
		&eph.Relations{Rel: "r", Cardinality: &eph.OneOne{Kind: "p", OtherKind: "q"}},
		&eph.Relations{Rel: "s", Cardinality: &eph.ManyOne{Kinds: "p", OtherKind: "q"}},
	)
	dt.MakeDomain(dd("c", "b"),
		&eph.Relations{Rel: "t", Cardinality: &eph.OneMany{Kind: "p", OtherKinds: "p"}},
		&eph.Relations{Rel: "u", Cardinality: &eph.ManyMany{Kinds: "q", OtherKinds: "p"}},
	)

	if _, e := dt.Assemble(); e != nil {
		t.Fatal(e)
	} else if out, e := dt.ReadRelations(); e != nil {
		t.Fatal(e)
	} else if diff := pretty.Diff(out, []string{
		"b:r:p:q:one_one",
		"b:s:p:q:any_one",
		"c:t:p:p:one_any",
		"c:u:q:p:any_any",
	}); len(diff) > 0 {
		t.Log(pretty.Sprint(out))
		t.Fatal(diff)
	}
}
