
{{/* ------------------------------------------ 
  expects text.
  names are prefixed with tilde so that they don't match in autocomplete.
   ------------------------------------------ */}}
{{- define "ref" }}
{ "$ref": "#/$defs/~{{ . }}" }
{{- end }}

{{/* ------------------------------------------ 
  expects sigTerm,
  sublime and vscode hovers look better without title.
  we already know what we're hovering.
  golsp seems not to use the title either.
   ------------------------------------------ */}}
{{- define "titledesc" -}}
  "description": "{{ .SchemaComment }}",
  "markdownDescription": "{{ .SchemaComment }}"
{{- end }}

{{/* ------------------------------------------ 
  expects sigTerm
   ------------------------------------------ */}}
{{- define "typedesc" -}}
{{- with $sigTerm := . -}}
\n\n---\n{{ 
  .Signature }}\n{{/* */ -}}
```yaml\n{{
  range .Terms 
  }}- {{ if .SimpleLabel }}{{ 
      .SimpleLabel }}{{ else 
  }}{{ $sigTerm.Lede }}{{ end
  }}: {{ Pascal .Type }}{{ 
    if .Repeats 
  }}...{{ end }}\n{{ 
end -}}
```\n{{/* */ -}}
{{- end -}}
{{- end -}}

{{/* ------------------------------------------ 
  expects slice of TypeLink
   ------------------------------------------ */}}
{{- define "typelinks" -}}
Types: {{ range $idx, $t := . -}}
{{- if $idx }}, {{ end -}}
[{{ Pascal .Type }}]({{ .Link }})
{{- end -}}
{{- end -}}

{{/* ------------------------------------------ */}}
{
  {{/* redhat yaml-language-server and vscode idxelf use draft 7 */}}
  "$schema": "https://json-schema.org/draft-07/schema",
  "$id": "https://tapestry.ionous.net/schema/tell/v1",
  {{ template "titledesc" . }}, 
  {{- /* the top level is an array of story statements*/}}
  "type": [
  "array",
  "null"
  ],
  "items": {
    "$ref": "#/$defs/~story_statement"
  },
  "$defs": {
    {{ range .Slot }} {{/*a map of SlotList */}}      
    "~{{.Name}}": {
        {{ template "titledesc" . }},
        "anyOf": [ {{/* technically should be oneOf, but this behaves better */}}
          {{/* handle shortcut.ReadDots */}}
          {{ if ( Contains .Name "bool_eval" "number_eval" "text_eval"
            "num_list_eval" "text_list_eval" "record_eval" "record_list_eval"
            "address" ) }}
          {
            "type": "string"
          },
          {{ end }}
          {{/* handle literal.DecodeLiteral */}}
          {{ if eq .Name "bool_eval" }}
           {
            "type": "boolean"
          },
          {{ else if eq .Name "number_eval" }}
           {
            "type": "number"
          },
          {{/* text already supported by readdots */}}
          {{ else if eq .Name "num_list_eval" }}
           {
            "type": "array",
            "items": { "type": "number" }
          },
          {{ else if eq .Name "text_list_eval" }}
           {
            "type": "array",
            "items": { "type": "string" }
          },
          {{ end }}
          {{- range $idx, $t := .Types -}}
            {{- if $idx }},{{ end }}
            {{ template "ref" $t -}}
          {{ end }}
        ]
      },
    {{- end }}{{/* slot */}}
    {{ range  .Str }}
    "~{{.Name}}": {
        {{ template "titledesc" . }},
        "type": "string"
        {{- if .Options }},
        "enum": [
        {{- range $idx, $opt := .Options -}}
          {{- if $idx }},{{ end }} "{{ . }}"
        {{- end }} ]
        {{ end }}
        {{- if .OptionComments }},
        "enumDescriptions": [
        {{- range $idx, $opt := .OptionComments -}}
          {{- if $idx }},{{ end }} "{{ . }}"
        {{- end }} ]
        {{ end }}
      },
    {{ end }}{{/* str */}}
    {{ range .Num }}
    "~{{.Name}}": {
        {{ template "titledesc" . }},
        "type": "number"
      },
    {{ end }}{{/* num */}}
    {{ range $op := .Flow }}
      "~{{.Name}}": {
        "type": "object",
        "anyOf": [ {{/* technically should be oneOf, but this behaves better */}}
        {{- range $idx, $sigTerm := .Signatures -}}
          {{- if $idx }},{{ end }}
            {
            "required": [
              "{{ .TrimmedSignature }}"
            ],
            "properties": {
              "{{ .TrimmedSignature }}": {
                "description": "{{ $op.SchemaComment }}",
                "markdownDescription": 
                "{{ $op.SchemaComment }}{{ 
                  template "typedesc" . }}{{
                  template "typelinks" .TypeLinks }}",
                "type": 
                {{- if not .Terms }}
                  "null"
                {{- else }}
                  "array",
                  "additionalItems": false,
                  "items": [
                  {{- range $it, $term:= .Terms -}}
                    {{- if $it }},{{ end }}
                    {{ template "ref" (print $op.Name "." .Name) }}
                  {{ end }}
                  ]
                {{- end }}{{/* if not terms */}}
              } 
            }
          }
        {{ end }}{{/* range Signatures */}}
        ]
      },
      {{/* 
        per flow terms
        */}}
      {{- range .Terms -}}
      {{ if not .Private }}
        "~{{ $op.Name }}.{{ .Name }}":
        {
        {{- if not .Repeats }}
          "$ref": "#/$defs/~{{ .Type }}",
        {{- else }}
         "type": "array",
         {{/* the docs are confusing, but: in draft 7
         	   the value of "items" indicates the array type.
         	   a json object means repeating items;
         	   a json array, a tuple. */}}
         "items":  {{ template "ref" .Type }},
        {{- end }}{{/* term repeats */}}
         "description": "{{ .SchemaComment }}",
         "markdownDescription": 
          "{{ .SchemaComment 
          }}\n\nType: [{{ Pascal .Type }}]({{ .Link }})"
        },
      {{ end }}
      {{ end }}{{/* range terms */}}
    {{ end }}{{/* flow */}}
    "xxx_eat_the_trailing_comma": {}
  }{{/* defs */}}
}
